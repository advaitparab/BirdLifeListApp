<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
<nav class="navbar">
    <div class="logo">Winged Waypoints</div>
    <div class="navlinks">
        <a th:href="@{/home}">Home</a>
        <a th:href="@{/myWaypoints}">My Winged Waypoints</a>
    </div>
</nav>

<h1>Home</h1>

<div class="alert" th:if="${loadError}">Could not load birds.</div>

<form method="get" th:action="@{/home}">
    <input type="text" name="q" placeholder="Search birds..." th:value="${q}"/>

    <select name="color">
        <option value="">Color</option>
        <option th:each="color : ${colors}"
                th:value="${color}"
                th:text="${color}"
                th:selected="${color == selectedColor}">
        </option>
    </select>

    <select name="location">
        <option value="">Location</option>
        <option th:each="loc : ${locations}"
                th:value="${loc}"
                th:text="${loc}"
                th:selected="${loc == selectedLocation}">
        </option>
    </select>

    <button type="submit">Search</button>
    <button type="button" id="openAddBirdModal" class="btn-add">Add New Bird</button>
</form>

<div class="bird-list" th:if="${birds != null}">
    <div class="bird-card" th:each="bird : ${birds}">
        <div class="card-titles">
            <h2 th:text="${bird.commonName}"></h2>
            <h4 th:text="${bird.speciesName}"></h4>
        </div>

        <div class="card-body">
            <div class="details">
                <p><strong>Color:</strong> <span th:text="${bird.color}"></span></p>
                <p><strong>Common Locations:</strong> <span th:text="${bird.defaultLocation}"></span></p>
                <p><strong>Description:</strong> <span th:text="${bird.description}"></span></p>
            </div>

            <div class="buttons">
                <a th:href="@{'/birds/details/' + ${bird.birdId}}">Edit</a>

                <button type="button"
                        class="btn-add-observation"
                        th:data-bird-id="${bird.birdId}">
                    Save Sighting
                </button>
            </div>
        </div>
    </div>
</div>

<p class="alert" th:if="${birds != null and #lists.isEmpty(birds)}">No birds found.</p>


<!-- OBSERVATION MODAL -->
<div id="observationModal" class="modal">
    <div class="modal-content">

        <h2>Add Observation</h2>

        <form id="observationForm">

            <input type="hidden" id="obsBirdId">

            <label>Date Seen:</label>
            <input type="date" id="dateSeen" required>

            <label>Location Seen:</label>
            <input type="text" id="locationSeen" required>

            <label>Notes:</label>
            <textarea id="notes"></textarea>

            <button type="submit">Save to My Winged Waypoints</button>
            <button type="button" id="closeObservationModal">Cancel</button>
        </form>
    </div>
</div>

<!-- ADD BIRD MODAL -->
<div id="addBirdModal" class="modal">
    <div class="modal-content">
        <h2>Add a New Bird</h2>

        <form id="addBirdForm">
            <label>Common Name:</label>
            <input type="text" name="commonName" required>

            <label>Species Name:</label>
            <input type="text" name="speciesName" required>

            <label>Color:</label>
            <input type="text" name="color" required>

            <label>Default Location:</label>
            <input type="text" name="defaultLocation" required>

            <label>Description:</label>
            <textarea name="description" required></textarea>

            <button type="submit">Save Bird</button>
            <button type="button" id="closeAddBirdModal">Cancel</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        console.log("HOME SCRIPT LOADED");

        // -----------------------------
        // ADD BIRD MODAL
        // -----------------------------
        const addModal = document.getElementById("addBirdModal");
        const openAddBtn = document.getElementById("openAddBirdModal");
        const closeAddBtn = document.getElementById("closeAddBirdModal");
        const addBirdForm = document.getElementById("addBirdForm");

        // Open "Add Bird" modal
        if (openAddBtn && addModal) {
            openAddBtn.onclick = () => addModal.style.display = "flex";
        }

        // Close "Add Bird" modal
        if (closeAddBtn && addModal) {
            closeAddBtn.onclick = () => addModal.style.display = "none";
        }

        // Submit "Add Bird" form (only if it exists)
        if (addBirdForm) {
            addBirdForm.onsubmit = async function (e) {
                e.preventDefault();

                const payload = {
                    commonName: addBirdForm.commonName.value,
                    speciesName: addBirdForm.speciesName.value,
                    color: addBirdForm.color.value,
                    defaultLocation: addBirdForm.defaultLocation.value,
                    description: addBirdForm.description.value
                };

                try {
                    const response = await fetch('/api/birds', {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        alert("Bird added!");
                        if (addModal) {
                            addModal.style.display = "none";
                        }
                        window.location.reload();
                    } else {
                        const text = await response.text();
                        alert("Failed to add bird: " + text);
                    }
                } catch (err) {
                    alert("Error adding bird: " + err);
                }
            };
        }

        // -----------------------------
        // OBSERVATION MODAL
        // -----------------------------
        const obsModal = document.getElementById("observationModal");
        const obsForm = document.getElementById("observationForm");
        const closeObsBtn = document.getElementById("closeObservationModal");

        // Open Observation modal from each "Add to Winged Waypoints" button
        document.querySelectorAll(".btn-add-observation").forEach(btn => {
            btn.addEventListener("click", () => {
                const birdId = btn.dataset.birdId;
                console.log("Opening observation modal for bird:", birdId);
                const hidden = document.getElementById("obsBirdId");
                if (hidden) hidden.value = birdId;
                if (obsModal) obsModal.style.display = "flex";
            });
        });

        // Close Observation modal
        if (closeObsBtn && obsModal) {
            closeObsBtn.onclick = () => {
                obsModal.style.display = "none";
            };
        }

        // Submit Observation form
        if (obsForm && obsModal) {
            obsForm.onsubmit = async function (e) {
                e.preventDefault();

                const birdId = Number(document.getElementById("obsBirdId").value);

                const payload = {
                    dateSeen: document.getElementById("dateSeen").value,
                    locationSeen: document.getElementById("locationSeen").value,
                    notes: document.getElementById("notes").value
                };

                try {
                    const res = await fetch(`/api/mylist/${birdId}/observation`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        alert("Observation added!");
                        obsModal.style.display = "none";
                        obsForm.reset();
                        document.getElementById("obsBirdId").value = "";
                    } else {
                        let msg = "Failed to save observation.";
                        try {
                            const errBody = await res.json();
                            if (errBody && errBody.message) {
                                msg += " " + errBody.message;
                            }
                        } catch (_) {
                            // response not JSON, ignore
                        }
                        alert(msg);
                    }
                } catch (err) {
                    alert("Error while saving observation: " + err);
                }
            };
        }
    });
</script>
</body>
</html>
