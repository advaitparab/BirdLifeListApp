<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Home</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">


</head>
<body>
<nav class="navbar">
    <div class="logo">Winged Waypoints</div>
    <div class="navlinks">
        <a th:href="@{/home}">Home</a>
        <a th:href="@{/myWaypoints}">My Winged Waypoints</a>
    </div>
</nav>

<!-- Header -->
<h1>Home</h1>

<!--error-->
<div class="alert" th:if="${loadError}">
    Could not load birds.
</div>

<form method="get" th:action="@{/home}">
    <!-- Search -->
    <input type="text" name="q" placeholder="Search birds..." th:value="${q}"/>

    <!-- Color Filter -->
    <select name="color">
        <option value="">Color</option>
        <option th:each="color : ${colors}"
                th:value="${color}"
                th:text="${color}"
                th:selected="${color == selectedColor}">
        </option>
    </select>

    <!-- Location Filter -->
    <select name="location"> <!-- This is the non-blank "no filter" option -->
        <option value="">Location</option>
        <option th:each="loc : ${locations}"
                th:value="${loc}"
                th:text="${loc}"
                th:selected="${loc == selectedLocation}">
        </option>
    </select>
    <button type="submit">Search</button>
</form>

<button type="button" id="openAddBirdModal" class="btn-add">Add New Bird</button>

    <div class="bird-list" th:if="${birds != null}">

        <div class="bird-card" th:each="bird : ${birds}">

            <div class="card-titles">
                <h2 th:text="${bird.commonName}">Blue Jay</h2>
                <h4><span th:text="${bird.speciesName}">Cyanocitta cristata</span></h4>
            </div>

            <div class="card-body">

                <div class="details">
                    <p><strong>Color:</strong> <span th:text="${bird.color}">Blue</span></p>
                    <p><strong>Common Locations:</strong> <span th:text="${bird.defaultLocation}">Ohio</span></p>
                    <p><strong>Description:</strong> <span th:text="${bird.description}">this is a test description</span></p>
                </div>

                <div class="buttons">
                    <a th:href="@{'/birds/details/' + ${bird.birdId}}">Details</a>
                    <form th:action="@{'/mylist/add/' + ${bird.birdId}}" method="post">
                        <button type="submit">Add to Winged Waypoints</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<p class="alert" th:if="${birds != null and #lists.isEmpty(birds)}">No birds found.</p>

<!-- Bird Modal -->
<div id="addBirdModal" class="modal">
    <div class="modal-content">
        <h2>Add a New Bird</h2>

        <form id="addBirdForm">
            <label>Common Name:</label>
            <input type="text" id="commonName" name="commonName" required>

            <label>Species Name:</label>
            <input type="text" id="speciesName" name="speciesName" required>

            <label>Color:</label>
            <input type="text" id="color" name="color" required>

            <label>Default Location:</label>
            <input type="text" id="defaultLocation" name="defaultLocation" required>

            <label>Description:</label>
            <textarea name="description" required></textarea>

            <button type="submit">Save Bird</button>
            <button type="button" id="closeAddBirdModal">Cancel</button>
        </form>
    </div>
</div>

<script>
    console.log("SCRIPT LOADED");

    const modal = document.getElementById("addBirdModal");
    const openBtn = document.getElementById("openAddBirdModal");
    const closeBtn = document.getElementById("closeAddBirdModal");
    const form = document.getElementById("addBirdForm");

    const apiUrl = /*[[@{/api/birds}]]*/ '/api/birds';

    openBtn.onclick = () => modal.style.display = "flex";
    closeBtn.onclick = () => modal.style.display = "none";

    document.addEventListener("click", function(e) {
        console.log("GLOBAL CLICK:", e.target);
    });

    form.onsubmit = async function(e) {
    e.preventDefault();

    const payload = {
        commonName: form.querySelector('input[name="commonName"]').value,
        speciesName: form.querySelector('input[name="speciesName"]').value,
        color: form.querySelector('input[name="color"]').value,
        defaultLocation: form.querySelector('input[name="defaultLocation"]').value,
        description: form.querySelector('textarea[name="description"]').value
    };

    // CSRF token is optional; remove if not needed
    const csrfInput = form.querySelector('input[name="_csrf"]');
    const headers = { "Content-Type": "application/json" };
    if (csrfInput) headers["X-CSRF-TOKEN"] = csrfInput.value;

    try {
        const response = await fetch(apiUrl, {
            method: "POST",
            headers: headers,
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            alert("Bird added!");
            modal.style.display = "none";
            window.location.reload();
        } else {
            const text = await response.text();
            alert("Failed to add bird: " + text);
        }
    } catch (err) {
        alert("Network error: " + err);
    }
};

</script>
</body>
</html>
